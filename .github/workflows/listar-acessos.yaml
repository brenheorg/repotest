name: Listar acessos por time

on:
  workflow_dispatch:

jobs:
  listar-acessos:
    runs-on: ubuntu-latest
    env:
      ORG: testorg
      GH_TOKEN: ${{ secrets.GH_PAT }}

    steps:
      - name: Instalar gh CLI
        uses: cli/gh-action@v2

      - name: ðŸ”§ Instalar jq
        run: sudo apt-get install -y jq

      - name: Baixar repositÃ³rio
        uses: actions/checkout@v4

      - name: Gerar CSV de acessos
        run: |
          echo "Repositorio,Time,Permissao" > acessos_por_time.csv

          repos=$(gh repo list "$ORG" --limit 1000 --json name -q '.[].name')

          for repo in $repos; do
            echo " Verificando: $repo"
            teams=$(gh api "/orgs/$ORG/repos/$repo/teams" --jq '.[] | {name: .name, permission: .permission}')
            if [ -n "$teams" ]; then
              echo "$teams" | jq -r --arg repo "$repo" '. | "\($repo),\(.name),\(.permission)"' >> acessos_por_time.csv
            fi
          done

      - name: Publicar CSV como artefato
        uses: actions/upload-artifact@v4
        with:
          name: acessos-times
          path: acessos_por_time.csv
